# README

This repository contains a simple Rails 6.1 blog application with Active Storage, Capistrano deployment, and S3 integration.  The following notes cover common issues and the current configuration.

## Deployment (Capistrano + Unicorn + Nginx)

* The app is configured to run under Unicorn rather than Puma.  the `Gemfile` includes `unicorn` in the production group and `capistrano3-unicorn` is used for deployments.
* `config/unicorn.rb` defines a socket, pidfile and worker count; Capistrano tasks restart Unicorn automatically.  See the `config/deploy.rb` file for hooks.
* A sample Nginx configuration is stored in `config/deploy/nginx.conf.erb`.  Deployers should copy this to `/etc/nginx/sites-available` on the server, update `server_name` to the public IP or domain and enable it.
* Ensure the target host has ImageMagick (or libvips) installed, and that the `unicorn` user can write to the shared `tmp` directories.

## Active Storage & S3

* Storage settings live in `config/storage.yml`.  the `amazon` service is used in production and is referenced by name in `config/environments/production.rb`.
  the YAML has been updated to fall back to standard AWS environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, AWS_BUCKET) so you can maintain credentials outside of the repo.  Objects are created with `public: true` so the URLs generated by `url_for` point directly at S3.
* Credentials for `:aws` (access_key_id/secret_access_key) must be stored in `config/credentials.yml.enc` or provided via ENV when running in production.  Make sure the `bucket` name is correct and that the bucket policy allows public reads (or adjust the policy / CORS settings appropriately).
* The example views (`app/views/blogs`) now guard against missing attachments and rescue variant processing errors.  If ImageMagick is not available you will see the original blob instead of a resized variant.
* If you observe uploads appear in the bucket but images fail to render, doubleâ€‘check bucket policies and CORS, and review the Rails log for ActiveStorage errors.  The controller will log failures and display a friendly message; uploads that fail because of network or permission issues will now be rescued and presented as a form error instead of a 500 page.

## Development

* By default the development environment uses local disk storage (`config.active_storage.service = :local`).

> **Windows users:** the `unicorn` gem (and its dependencies `kgio`/`raindrops`) are only needed in production and will fail to build on Windows.  Run `bundle config set --local without 'production'` (or `bundle install --without production`) before running the app locally to avoid errors.
* To preview S3 behavior locally you can set `RAILS_ENV=production` or override the service with `rails credentials:edit`.
* Make sure to run `bundle install` after editing the `Gemfile` and to restart the server whenever you change configuration.



This README would normally document whatever steps are necessary to get the
application up and running.

Things you may want to cover:

* Ruby version

* System dependencies

* Configuration

* Database creation

* Database initialization

* How to run the test suite

* Services (job queues, cache servers, search engines, etc.)

* Deployment instructions

* ...
